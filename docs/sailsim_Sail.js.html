<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: sailsim/Sail.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: sailsim/Sail.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* 
 * Copyright 2017 Albert Santos.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


/* global LBSailSim, LBFoils, LBControls, LBGeometry, LBMath, LBPhysics */

/**
 * Implementation of {@link LBFoils.Foil} for sails, supports reefing and flatness factors.
 * @constructor
 * @param {LBSailSim.SailInstance} sailInstance The sail instance that owns this.
 * @returns {LBSailSim.SailFoil}
 */
LBSailSim.SailFoil = function(sailInstance) {
    LBFoils.Foil.call(this);
    this.sailInstance = sailInstance;
};

LBSailSim.SailFoil.prototype = Object.create(LBFoils.Foil.prototype);
LBSailSim.SailFoil.prototype.constructor = LBSailSim.SailFoil;

/**
 * @todo Implement the reefing and flatness factors...
 * @param {Number} rho  The fluid density.
 * @param {object} qInfLocal    The free stream velocity in the local x-y plane.
 * @param {object} [details]  If defined, an object to receive details about the calculation.
 * @param {object} [store]  If defined, the object to receive the forces and moment.
 * @returns {object}    The object containing the forces and moment.
 */
LBSailSim.SailFoil.prototype.calcLocalLiftDragMoment = function(rho, qInfLocal, store, details) {
    var result = LBFoils.Foil.prototype.calcLocalLiftDragMoment.call(rho, qInfLocal, store, details);
    
    // TODO: Apply the reefing factor, flatness factor.
    
    // The Cl/Cd curve will be from the books...
    // Need a luffing state.
    
    return result;
};


/**
 * The {@link LBSailSim.FoilInstance} implementation for sails.
 * @constructor
 * @extends LBSailSim.FoilInstance
 * @returns {LBSailSim.SailInstance}
 */
LBSailSim.SailInstance = function() {
    var foil = new LBSailSim.SailFoil(this);
    LBSailSim.FoilInstance.call(this, foil);
    
    /**
     * The flatness factor, 0 is most flat, 1 is least flat.
     * @member {Number}
     */
    this.flatness = 0.5;
    
    /**
     * The twist factor, 0 is least twist, 1 is most twist.
     * @member {Number}
     */
    this.twist = 0.5;
    
    /**
     * The reefing factor, 0 is most reefed, 1 is not reefed.
     * @member {Number}
     */
    this.reef = 1;
    
    /**
     * ??? Forgot what vreef stands for!
     */
    this.vreef = 1;
    
    /**
     * The anchor point of the sheet on the sail in local coordinates.
     * @member {LBGeometry.Vector3}
     */
    this.sheetAnchorSail = new LBGeometry.Vector3();
    
    /**
     * The anchor point of the sheet on the boat, in sail local coordinates.
     * TODO Need a little clarification here, how is this really used?!?
     * @member {LBGeometry.Vector3}
     */
    this.sheetAnchorBoat = new LBGeometry.Vector3();
    
    /**
     * The length of the sheet.
     * @member {Number}
     */
    this.sheetLength = 0;
    
    /**
     * The minimum sheet length.
     * @member {Number}
     */
    this.minSheetLength = 0;
    
    /**
     * The maximum sheet length.
     * @member {Number}
     */
    this.maxSheetLength = 1;
    
    /**
     * The spars associated with this sail.
     * @member {LBPhysics.RigidBody[]}
     */
    this.spars = [];
    
    /**
     * The minimum rotation angle of the sail in degrees, set by {@link LBSailSim.SailInstance#_updateRotationLimits}.
     * @readonly
     * @member {Number}
     */
    this.minRotationDeg = 0;
    
    /**
     * The maximum rotation angle of the sail in degrees, set by {@link LBSailSim.SailInstance#_updateRotationLimits}.
     * @readonly
     * @member {Number}
     */
    this.maxRotationDeg = 0;
};


LBSailSim.SailInstance.prototype = Object.create(LBSailSim.FoilInstance.prototype);
LBSailSim.SailInstance.prototype.constructor = LBSailSim.SailInstance;

// @inheritdoc...
LBSailSim.SailInstance.prototype.updateFoilForce = function(dt, flow) {
    LBSailSim.FoilInstance.prototype.updateFoilForce.call(this, dt, flow);

    // Here we're integrating the force on the sail around the local z-axis and origin to
    // figure out the position of the sail.
    var currentDeg = this.obj3D.rotation.z * LBMath.RAD_TO_DEG;
    this.integrateForceForRotation(LBGeometry.ORIGIN, LBGeometry.Z_AXIS, currentDeg, function(deg) {
        deg += this.rotationOffsetDegs[2];
        var deg2 = LBMath.clamp(deg, this.minRotationDeg, this.maxRotationDeg);
        return deg2 - this.rotationOffsetDegs[2];
    });
    
    // Match the locations of any spars to the sail location.
    this.spars.forEach(function(spar) {
        spar.setPositionAndQuaternion(this.obj3D.position, this.obj3D.quaternion);
    }, this);
    
    return this;
};

/**
 * This handles calculating the rotation limits {@link LBSailSim.SailInstance#minRotationDeg}
 * and {@link LBSailSim.SailInstance#maxRotationDeg} based on the current sheet length.
 * @protected
 * @returns {undefined}
 */
LBSailSim.SailInstance.prototype._updateRotationLimits = function() {
    // TODO: Handle multiple sheets (i.e. jib sheeets and spinnakers...)
    
    var a = this.sheetAnchorSail.length();
    var b = this.sheetAnchorBoat.length();
    var c = this.sheetLength;
    
    if (c &lt; (a + b)) {
        this.maxRotationDeg = LBMath.radFromThreeSides(a, b, c) * LBMath.RAD_TO_DEG;
    }
    else {
        this.maxRotationDeg = 180;
    }
    this.minRotationDeg = -this.maxRotationDeg;

    var deg = this.obj3D.rotation.z * LBMath.RAD_TO_DEG + this.rotationOffsetDegs[2];
    var deg2 = LBMath.clamp(deg, this.minRotationDeg, this.maxRotationDeg);
    if (deg !== deg2) {
        deg2 -= this.rotationOffsetDegs[2];
        var rad = (deg2 - deg) * LBMath.DEG_TO_RAD;
        this.obj3D.rotateOnAxis(LBGeometry.Z_AXIS, rad);
        
        this.spars.forEach(function(spar) {
            spar.setPositionAndQuaternion(this.obj3D.position, this.obj3D.quaternion);
        }, this);
    }
};

// @inheritdoc...
LBSailSim.SailInstance.prototype.load = function(data, sailEnv) {
    LBSailSim.FoilInstance.prototype.load.call(this, data, sailEnv);
    
    this.sparName = data.sparName;

    if (!data.sheetSailAnchor) {
        // If the sheet anchor on the sail was not specified, make it the mid-point
        // of the chord, which we'll presume is the boom.
        var chord = this.foil.chordLine;
        this.sheetAnchorSail.copy(chord.start);
        this.sheetAnchorSail.add(chord.end).multiplyScalar(0.5);
    }
    else {
        LBGeometry.loadVector3(data.sheetSailAnchor, this.sheetAnchorSail);
    }
    if (!data.sheetBoatAnchor) {
        // If the sheet anchor on the boat was not specified, make it the same as
        // the sheet anchor on the sail at the current orientation.
        this.sheetAnchorBoat.copy(this.sheetAnchorSail);
    }
    else {
        LBGeometry.loadVector3(data.sheetBoatAnchor, this.sheetAnchorBoat);
    }
    
    this.minSheetLength = data.minSheetLength || 0;
    this.maxSheetLength = data.maxSheetLength || 1;
    
    this._updateRotationLimits();
    return this;
};

// @inheritdoc
LBSailSim.SailInstance.prototype.vesselLoaded = function(vessel) {
    LBSailSim.FoilInstance.prototype.vesselLoaded.call(this, vessel);
    
    if (this.sparName) {
        LBPhysics.RigidBody.getRigidBodiesWithName(vessel.spars, this.sparName, this.spars);
    }
    return this;
};

/**
 * Sets the sheet length.
 * @param {Number} length   The sheet length.
 * @returns {LBSailSim.SailInstance} this.
 */
LBSailSim.SailInstance.prototype.setSheetLength = function(length) {
    this.sheetLength = LBMath.clamp(length, this.minSheetLength, this.maxSheetLength);
    this._updateRotationLimits();
    return this;
};

/**
 * Sets the sheet length based on a ratio between the minimum and maximum sheet lengths.
 * @param {Number} ratio    The sheet length ratio, 0 is the minimun sheet length,
 * 1 is the maximum sheet length.
 * @returns {LBSailSim.SailInstance}  this.
 */
LBSailSim.SailInstance.prototype.setSheetLengthRatio = function(ratio) {
    var length = this.minSheetLength + ratio * (this.maxSheetLength - this.minSheetLength);
    return this.setSheetLength(length);
};


/**
 * Basic sail controller, sets the sheet length.
 * @constructor
 * @param {LBSailSim.Vessel} vessel The vessel which this helps control.
 * @returns {LBSailSim.SailController}
 */
LBSailSim.SailController = function(vessel) {
    LBControls.SmoothController.call(this);

    /**
     * The vessel to which this belongs.
     * @member {LBSailSim.Vessel}
     */
    this.vessel = vessel;
    
    /**
     * The name of the sails which are controlled by this.
     * @member {String}
     */
    this.sailName = 'sail';
    
    /**
     * The array of sails controlled by this.
     * @member {Array}
     */
    this.sails = [];
    
};


LBSailSim.SailController.prototype = Object.create(LBControls.SmoothController.prototype);
LBSailSim.SailController.prototype.constructor = LBSailSim.SailController;

/**
 * Loads the controller from the properties in a data object.
 * @param {object} data The data object.
 * @param {LBSailSim.Vessel} vessel The vessel to which this belongs.
 * @returns {LBSailSim.SailController}  this.
 */
LBSailSim.SailController.prototype.load = function(data, vessel) {
    this.controllee = function(value) {
        this.setSheetLength(value);
    };
    
    this.vessel = vessel;
    LBControls.SmoothController.prototype.load.call(this, data, vessel);
    this.sailName = data.sailName || 'sail';
    this._loadSails();
    this.setSheetLength(this.currentValue);
    return this;
};

/**
 * Gathers up the sails controlled by this controller.
 * @returns {undefined}
 */
LBSailSim.SailController.prototype._loadSails = function() {
    if (!this.vessel) {
        return;
    }
    
    LBPhysics.RigidBody.getRigidBodiesWithName(this.vessel.airfoils, this.sailName, this.sails);
};

/**
 * Changes the sheet length for all the sails.
 * @param {Number} value    The sheet length.
 * @returns {undefined}
 */
LBSailSim.SailController.prototype.setSheetLength = function(value) {
    var ratio = (value - this.minValue)  / (this.maxValue - this.minValue);
    for (var i = 0; i &lt; this.sails.length; ++i) {
        this.sails[i].setSheetLengthRatio(ratio);
    }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="LBCamera.Camera.html">Camera</a></li><li><a href="LBCamera.OrthographicCamera.html">OrthographicCamera</a></li><li><a href="LBCamera.PerspectiveCamera.html">PerspectiveCamera</a></li><li><a href="LBControls.CSplineValueMapper.html">CSplineValueMapper</a></li><li><a href="LBControls.SmoothController.html">SmoothController</a></li><li><a href="LBControls.SteppedController.html">SteppedController</a></li><li><a href="LBFoils.ClCd.html">ClCd</a></li><li><a href="LBFoils.ClCdCurve.html">ClCdCurve</a></li><li><a href="LBFoils.ClCdInterp.html">ClCdInterp</a></li><li><a href="LBFoils.ClCdStall.html">ClCdStall</a></li><li><a href="LBFoils.Foil.html">Foil</a></li><li><a href="LBGeometry.Color.html">Color</a></li><li><a href="LBGeometry.Euler.html">Euler</a></li><li><a href="LBGeometry.Face3.html">Face3</a></li><li><a href="LBGeometry.Geometry.html">Geometry</a></li><li><a href="LBGeometry.Line2.html">Line2</a></li><li><a href="LBGeometry.Line3.html">Line3</a></li><li><a href="LBGeometry.Matrix3.html">Matrix3</a></li><li><a href="LBGeometry.Matrix4.html">Matrix4</a></li><li><a href="LBGeometry.Object3D.html">Object3D</a></li><li><a href="LBGeometry.Plane.html">Plane</a></li><li><a href="LBGeometry.Quaternion.html">Quaternion</a></li><li><a href="LBGeometry.Sphere.html">Sphere</a></li><li><a href="LBGeometry.Vector2.html">Vector2</a></li><li><a href="LBGeometry.Vector3.html">Vector3</a></li><li><a href="LBMath.CSpline.html">CSpline</a></li><li><a href="LBPhaser.Arrow.html">Arrow</a></li><li><a href="LBPhaser.ArrowStyle.html">ArrowStyle</a></li><li><a href="LBPhaser.CannonLink.html">CannonLink</a></li><li><a href="LBPhaser.Dial.html">Dial</a></li><li><a href="LBPhaser.Env.html">Env</a></li><li><a href="LBPhaser.P2Link.html">P2Link</a></li><li><a href="LBPhaser.PhysicsLink.html">PhysicsLink</a></li><li><a href="LBPhaser.Project3D.html">Project3D</a></li><li><a href="LBPhaser.Project3DPanels.html">Project3DPanels</a></li><li><a href="LBPhaser.Slider.html">Slider</a></li><li><a href="LBPhysics.CoordSystemState.html">CoordSystemState</a></li><li><a href="LBPhysics.Resultant3D.html">Resultant3D</a></li><li><a href="LBPhysics.RigidBody.html">RigidBody</a></li><li><a href="LBSailSim.Env.html">Env</a></li><li><a href="LBSailSim.FoilInstance.html">FoilInstance</a></li><li><a href="LBSailSim.Hull.html">Hull</a></li><li><a href="LBSailSim.Phaser2DView.html">Phaser2DView</a></li><li><a href="LBSailSim.Phaser3DView.html">Phaser3DView</a></li><li><a href="LBSailSim.PhaserSailEnv.html">PhaserSailEnv</a></li><li><a href="LBSailSim.PhaserView.html">PhaserView</a></li><li><a href="LBSailSim.Propulsor.html">Propulsor</a></li><li><a href="LBSailSim.RudderController.html">RudderController</a></li><li><a href="LBSailSim.SailController.html">SailController</a></li><li><a href="LBSailSim.SailFoil.html">SailFoil</a></li><li><a href="LBSailSim.SailInstance.html">SailInstance</a></li><li><a href="LBSailSim.ThrottleController.html">ThrottleController</a></li><li><a href="LBSailSim.Vessel.html">Vessel</a></li><li><a href="LBSailSim.Water.html">Water</a></li><li><a href="LBSailSim.Wind.html">Wind</a></li><li><a href="LBVolume.Cuboid.html">Cuboid</a></li><li><a href="LBVolume.Tetra.html">Tetra</a></li><li><a href="LBVolume.TriBipyramid.html">TriBipyramid</a></li><li><a href="LBVolume.TriPrism.html">TriPrism</a></li><li><a href="LBVolume.Volume.html">Volume</a></li></ul><h3>Namespaces</h3><ul><li><a href="LBCamera.html">LBCamera</a></li><li><a href="LBCannon.html">LBCannon</a></li><li><a href="LBControls.html">LBControls</a></li><li><a href="LBFoils.html">LBFoils</a></li><li><a href="LBGeometry.html">LBGeometry</a></li><li><a href="LBMath.html">LBMath</a></li><li><a href="LBPhaser.html">LBPhaser</a></li><li><a href="LBPhysics.html">LBPhysics</a></li><li><a href="LBSailSim.html">LBSailSim</a></li><li><a href="LBVolume.html">LBVolume</a></li><li><a href="Leeboard.html">Leeboard</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sat Jul 29 2017 16:52:43 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
